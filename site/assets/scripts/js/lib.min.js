class KVIdb
{
  constructor ( db_s='kv_db', store_s='kv_store', version_n=1 )
  {
    this.idb_o     = null
    this.ready_o   = null
    this.idb_s     = db_s
    this.store_s   = store_s
    this.version_n = version_n

    this.init__v()
  }

  init__v ()
  {
    this.ready_o = new Promise( ( resolve, reject ) =>
    {
      const open_o = window.indexedDB.open( this.idb_s, this.version_n )

      open_o.onupgradeneeded = request_o => 
      {
        this.idb_o = request_o.target.result
        this.idb_o.createObjectStore( this.store_s )
      }

      open_o.onsuccess = request_o =>
      {
        this.idb_o = request_o.target.result
        resolve( request_o.target.result )    //: only to complete: in transactions, we use this.idb_o not result
      }

      open_o.onerror = request_o =>  reject( request_o.target.error )
    })
  }

  store__o ( mode_s='readonly' )
  {
    return this.idb_o
      .transaction( [ this.store_s ], mode_s )
      .objectStore( this.store_s )
  }

  set__v ( key_s, value_ )
  {
    return this.ready_o
      .then( () =>
      {
        return new Promise( ( resolve, reject ) =>
        {
          const set_o = this.store__o( 'readwrite' ).put( value_, key_s )

          set_o.onsuccess = resolve    //: nothing to do

          set_o.onerror = reject
        })
      })
  }

  update__v ( key_s, property, value_ )
  {
    return this.ready_o
      .then( () =>
      {
        return new Promise( ( resolve, reject ) =>
        {
          const store_o = this.store__o( 'readwrite' )
          const get_o = store_o.get( key_s )

          get_o.onsuccess = () =>
          {
            const item_o = get_o.result
            item_o[property] = value_
            const put_o = store_o.put( item_o, key_s )

            put_o.onsuccess = resolve
            
            put_o.onerror = reject
          }
          get_o.onerror = reject
        })
      })
  }

  walk__v ( callback_f )
  {
    return this.ready_o
      .then( () => 
      {
        return new Promise( ( resolve, reject ) =>
        {
          const walk_o = this.store__o().openCursor()
          walk_o.onsuccess = request_o =>
          {
            let cursor_o = request_o.target.result
            if ( cursor_o )
            {
              callback_f( cursor_o.key, cursor_o.value )
              cursor_o.continue()
            }
            else resolve()
          }
  
          walk_o.onerror = reject
        })
      })
  }

  get__ ( key_s )    //: anytyped value_
  {
    return this.ready_o
      .then( () => 
      {
        return new Promise( ( resolve, reject ) =>
        {
          const get_o = this.store__o().get( key_s )

          get_o.onsuccess = request_o => resolve( request_o.target.result )

          get_o.onerror = reject
        })
      })
  }

  key__b ( key_s )    //: return 1 for true : 0 for false
  {
    return this.ready_o
      .then( () => 
      {
        return new Promise( ( resolve, reject ) =>
        {
          const key_o = this.store__o().count( key_s )

          key_o.onsuccess = request_o => resolve( request_o.target.result )

          key_o.onerror = reject
        })
      })
  }

  last__ ()
  {
    return this.ready_o
      .then( () => 
      {
        return new Promise( ( resolve, reject ) =>
        {
          const last_o = this.store__o( 'readwrite' ).openCursor( null, 'prev' )

          last_o.onsuccess = request_o =>
          {
            if ( request_o.target.result ) resolve( request_o.target.result.value )
          }

          last_o.onerror = reject
        })
      })
  }

  deleteAll__v ( callback_f )
  {
    return this.ready_o
      .then( () => 
      {
        return new Promise( ( resolve, reject ) =>
        {
          const store_o = this.store__o( 'readwrite' )
          const delete_o = store.openCursor()

          delete_o.onsuccess = request_o =>
          {
            let cursor_o = request_o.target.result
            let item_o
            if ( cursor_o )
            {
              item_o = cursor_o.value
              if ( callback_f( item_o ) ) store_o.delete( cursor_o.key )
              cursor_o.continue()
            }
            else resolve
          }
  
          delete_o.onerror = reject
        })
      })
  }

  delete__v ( key_s )
  {
    return this.ready_o
      .then( () =>
      {
        return new Promise( ( resolve, reject ) =>
        {
          const delete_o = this.store__o( 'readwrite' ).delete( key_s )

          delete_o.onsuccess = resolve    //: nothing to do

          delete_o.onerror = reject
        })
      })
  }

  clear__v ()
  {
    return this.ready_o
      .then( () =>
      {
        return new Promise( ( resolve, reject ) =>
        {
          const clear_o = this.store__o( 'readwrite' ).clear()

          clear_o.onsuccess = resolve    //: nothing to do

          clear_o.onerror = reject
        })
      })
  }

  deleteIDB__v ()
  {
    window.indexedDB.deleteDatabase( this.idb_s )
  }
}//> Open IndexedDB
//> to store UI base color + light/dark mode
const idb_o = new KVIdb( 'wic_idb', 'wic_store', )

const hueBase__v = hue_n =>    //: if page load, mode_n undefined (no parameter)
{
  idb_o.get__( 'hue_base' )
    .then( current_n =>
    {
      if ( hue_n === undefined ) hue_n = current_n || +''  //: at page load only
      idb_o.set__v( 'hue_base', hue_n )
      DOM_rootVar__v( '--c_hue_base', hue_n )
      console.log( `Base hue has been set to: ${hue_n}` )
    } )
}

const lumMode__v = mode_n =>    //: if page load, mode_n undefined (no parameter)
{
  idb_o.get__( 'lum_mode' )
    .then( current_n =>
    {
      if ( mode_n === undefined ) mode_n = current_n || +'1'
      idb_o.set__v( 'lum_mode', mode_n )
      DOM_rootVar__v( '--lum_mode', mode_n )
      console.log( `Luminosity mode has been set to: ${mode_n} ${mode_n > 0 ?  '(LIGHT)' : '(DARK)'} ` )
    } )
}
const DOM_rootVar__s = var_s => window.getComputedStyle( document.documentElement ).getPropertyValue( var_s ) || ''

const DOM_rootVar__v = ( var_s, val_s ) => document.documentElement.style.setProperty( var_s, val_s )

const DOM_loader__v = ( selector_s, callback__, delay_n=0 ) =>
{
  const iframe_e = document.querySelector( selector_s )
  iframe_e.addEventListener('load', () =>
    {
      iframe_e.before( (iframe_e.contentDocument.body||iframe_e.contentDocument).children[0])
      iframe_e.remove()
      if ( callback__ )
      {
        if ( delay_n ) window.setTimeout( callback__, delay_n )
        else callback__()
      }
    } )
}

const DOM_siblings__a = selector_s =>
{
  const node_e = document.querySelector( selector_s )
  return !node_e ?
    null :
    Array.prototype.filter
      .call( node_e.parentNode.children, sibling_e => sibling_e !== node_e )
}

/**
 * HTML:
 * <ol data--="selector">
 *   <li>primo</li>
 * </ol>
 * JS:
 * DOM_listReverse__v( '[data--="["selector"]' )
 * 
 */
const DOM_listReverse__v = selector_s =>
{
  const nodes_a = Array.prototype.slice.call(document.querySelectorAll( `${selector_s} li` ))
  nodes_a.forEach( node_e => node_e.parentNode.insertBefore( node_e, node_e.parentNode.firstChild ) )
}

const DOM_scroll__v = bottom_b =>
{
  const options_o =
  {
    top: bottom_b ? document.querySelector( 'body' ).offsetHeight : 0,
    left: 0,
    behavior: 'smooth'
  }
  window.scroll( options_o )
}

const DOM_locationKey__s = () =>
{
  const extension_n = '.html'.length
  let location_s = window.location.href
  const key_s = location_s.slice( location_s.lastIndexOf( 'nouvelless/'), -extension_n )
  return key_s
}
/**
 * Service worker registration
 */
const service__v = url_s =>
{
  const REGISTRATION_s = 'ServiceWorker registration'
  const SUCCESS_s = 'successful'
  const FAILURE_s = 'failed'
  
  navigator.serviceWorker.register( url_s )
    .then( registration => console.log(  `${REGISTRATION_s} ${SUCCESS_s} [scope: ${registration.scope}]` ),
           error_o => console.log( `${REGISTRATION_s} ${FAILURE_s} [error: ${error_o}]` ) )
}
const shortNote__v = click_o =>
{
  const note_e = click_o.target.closest('INS')
  if ( note_e )
  {
    shortImg__v( note_e )    //: try for img
    note_e.querySelector( '[data--="note_content"]' ).classList.toggle( 'note_open' )
  }
}

const shortImg__v = note_e =>
{
  const img_e = note_e.querySelector('[data-src^="http"]')
  if ( !img_e ) return    //: already called

  const size_s = img_e.getAttribute( 'data-size' )
  if ( size_s )
  {
    const [ width_s, height_s ] = size_s.split( ' ' )
    if ( !width_s ) return
    const widthUnit_s = ( `${parseInt( width_s )}`.length === width_s.length ) ? 'px' : ''
    let style_s = `width:${width_s}${widthUnit_s};`
    if ( height_s )
    {
      const heightUnit_s = ( `${parseInt( height_s )}`.length === height_s.length ) ? 'px' : ''
      style_s += ` height:${height_s}${heightUnit_s};`
    }
    if ( style_s )
    {
      let currentStyle_s = img_e.getAttribute( 'style' )
      img_e.setAttribute( 'style', `${currentStyle_s || '' } ${style_s}` )
    }
  }
  
  img_e.decoding = 'async'
  img_e.src = img_e.getAttribute( 'data-src' )
  img_e.setAttribute( 'data-src', '' )    //: next querySelector call will be false
}

const loadColorImg__v = ( button_e, gray_s='gray', color_s='color' ) =>
{
  const note_e = button_e.closest( '.note_open' )
  const img_e = note_e.querySelector( 'img' )
  const src_s = img_e.getAttribute( 'src' )
  if ( !src_s.includes( gray_s ) ) return
  img_e.src = src_s.replace( gray_s, color_s )
  note_e.classList.toggle( 'note_open' )
}
//> adjust menu height + position
const menuPosition__v = () =>
{
  const menu_e = document.querySelector( `[data--="menu"]` )
  let position_n = document.querySelector( `[data--="header"]` ).offsetHeight
  position_n += document.querySelector( `[data--="link_page"]` ).offsetHeight
  menu_e.style.transform = `translateY( ${position_n}px)`
  const menu_n = menu_e.offsetHeight
  const article_e = document.querySelector( `[data--="article"]` )
  const article_n = article_e.offsetHeight
  if ( menu_n < article_n ) menu_e.style.height = `${article_n}px`
  else article_e.style.height = `${menu_n}px`
}

//> show/hide posts menu list
//> when menu is vsible comments are retracted
const menu__v = () =>
{
  const show_s = DOM_rootVar__s( '--MENU_SHOW' ) === '1' ? '0' : '1'
  DOM_rootVar__v( '--MENU_SHOW', show_s )
  comments_e = document.querySelector( '.utterances' )
  if ( comments_e !== null ) comments_e.classList.toggle( 'retract' )
  const menu_e =document.querySelector( `[data--="menu"]` )
  if ( show_s === '1' )
  {
    menu_e.classList.remove( 'no_pointer' )
    DOM_scroll__v()
  }
  else menu_e.classList.add( 'no_pointer' )
}
//> create the comments script (utteranc.es)
//> show/hide the comments block
const comments__v = () =>
{
  const comments_e = document.querySelector( '[data--="comments"]' )
  if ( !comments_e.hasChildNodes() )
  {
    const script_e = document.createElement( 'script' )
    script_e.setAttribute( 'data--', 'comments_script' )
    script_e.setAttribute( 'src', 'https://utteranc.es/client.js' )
    script_e.setAttribute( 'repo', 'octoxalis/wic' )
    script_e.setAttribute( 'issue-term', 't' )
    script_e.setAttribute( 'theme', 'photon-dark' )
    script_e.setAttribute( 'crossorigin', 'anonymous' )
    script_e.setAttribute( 'async', true )
    comments_e.appendChild( script_e )
  }
  comments_e.classList.toggle( 'retract' )
}

//> retrieve previous + next pages info
const linkNear__o = link_s =>
{
  const list_e = document.querySelector( `[data--="menu_list"]` )
  const extension_n = '.html'.length
  const location_s = window.location.pathname.slice( 1, -extension_n )  //: trim '/' at start
  const list_a = document.querySelectorAll( `[data--="menu_list"] > li` )
  if ( !list_a ) return     //: undefined
  const list_n = list_a.length
  const current_e = list_e.querySelector( `[data-link="${location_s}"]` )
  const rank_n = +current_e.getAttribute( 'data-rank' )
  const near_n = ( link_s === 'link_previous' ) ? rank_n - 1 : rank_n + 1
  if ( near_n < 1 || near_n > list_n ) return     //: undefined
  const near_e = list_e.querySelector( `[data-rank="${near_n}"]` )
  if ( !near_e ) return     //: undefined
  const a_e = near_e.querySelector( `span > a` )
  if ( !a_e ) return     //: undefined
  const span_e = near_e.querySelector( `span[data--="note_content"]` )
  if ( !a_e ) return     //: undefined
  return {
    link_s:     near_e.getAttribute( 'data-link' ),
    title_s:    a_e.innerHTML,
    //?? subtitle_s: '',
    abstract_s: span_e.innerHTML,
  }
}

//> insert in DOM previous + next pages info
//> show/hide previous + next pages info block
const linkNear__v = ( event_s, link_e ) =>
{
  if ( link_e === null ) return
  if ( event_s === 'mouseenter' )
  {
    const link_s = link_e.getAttribute( 'data--' )
    let title_s
    let abstract_s
    const near_o = linkNear__o( link_s )
    if ( near_o !== undefined )
    {
      title_s = `<a href="http://127.0.0.1:8080/${near_o.link_s}.html">${near_o.title_s}</a>`
      abstract_s = `<i>${near_o.abstract_s}</i>`
    }
    else
    {
      title_s = `Plus d'autres nouvelles`
      abstract_s = ''
    }
    document.querySelector( '[data--="link_title"]' ).innerHTML = title_s
    document.querySelector( '[data--="link_abstract"]' ).innerHTML = abstract_s
}
  document.querySelector( '[data--="link_info"]' )
    .classList.toggle( 'retract' )
}

//> transform the link_s path part in a full URL
const linkURL__s = link_s =>
{
  const link_o = linkNear__o( link_s )
  return link_o ? `http://127.0.0.1:8080/${link_o.link_s}.html` : undefined
}

/**
 * UI events
 */
void function ()
{
  DOM_loader__v( '[data--="menu_iframe"]', () =>
  {
    //> DOM_rootVar__v( '--c_hue_base', 100 )
//> Menu inline notes sup element click handler
//> to show/hide the note
    window.addEventListener('load', () =>
      {
        document.querySelector( '[data--="menu_list"]' )
          .addEventListener('click', shortNote__v )
      } )

//> Menu order click handler
//> to sort posts by reverse order
    document.querySelector( '[data--="menu_order"]' )
      .addEventListener('click', click_o =>
      {
        const menu_e = click_o.target.closest('menu')
        if ( menu_e ) DOM_listReverse__v( '[data--="menu_list"]' )
      } )

//> adjust menu height + position
    menuPosition__v()
  } )


//> register service worker
  if ( 'serviceWorker' in navigator ) window
    .addEventListener( 'load', service__v( 'http://127.0.0.1:8080/assets/scripts/js/service_worker.min.js' ) )

//> Page link click+hover handler
//> to show menu or go to another page
  const linkNav_e = document.querySelector( '[data--="link_nav"]' )
  if ( linkNav_e != null )
  {
    linkNav_e.addEventListener('click', click_o => 
    {
      const link_e = click_o.target.closest('BUTTON')
      if ( link_e === null ) return
      let link_s = link_e.getAttribute( 'data--' )
      /*
      if ( link_s === 'link_menu' ) return void menu__v()
      //: previous or next tip
      const http_s = linkURL__s( link_s )
      if ( http_s ) window.location = http_s
      */
      switch ( link_s )
      {
        case ( 'link_menu' ) : return void menu__v()
        case ( 'link_top' ) :
        case ( 'link_bottom' ) : return void DOM_scroll__v( link_s === 'link_bottom' )
        case ( 'link_previous' ) :
        case ( 'link_next' ) :
        {
          const http_s = linkURL__s( link_s )
          if ( http_s ) window.location = http_s
        }
      }
    } )

    document.querySelectorAll( '[data--="link_nav"] > button' )
      .forEach( button_e =>
      {
        switch ( button_e.getAttribute( 'data--' ) )
        {
          case 'link_top' :
          case 'link_bottom' :
          case 'link_menu' : return
        }
        [ 'mouseenter', 'mouseleave' ]
          .forEach( event_s => button_e.addEventListener( event_s,
            mouse_o => linkNear__v( event_s, mouse_o.currentTarget ) ) )
      } )
  }

//> Article inline notes sup element click handler
//> to show/hide notes
  document.querySelector( '[data--="article"]' )
    .addEventListener('click', shortNote__v )

//> Comments visibility click handler
//> to show/hide comments
  const visibility_e = document.querySelector( '[data--="comments_visibility"]' )
  if ( visibility_e ) visibility_e.addEventListener('click', click_o => comments__v() )

//> Open IndexedDB
//> to store UI base color + light/dark mode
  hueBase__v()
  lumMode__v()

//> Easter egg for developers who read sources
//> change UI base color + light/dark mode
  const header_e = document.querySelector( '[data--="header"]' )
  header_e.addEventListener('click', click_o =>
    {
      const HUE_SET_n = +'1'
      if ( HUE_SET_n )
      {
        const atX_n = click_o.clientX - header_e.getBoundingClientRect().left
        const width_n = header_e.offsetWidth
        const hue_n = ~~( ( atX_n / width_n ) * 360 )
        hueBase__v( hue_n )
      }
      const atY_n = click_o.clientY - header_e.getBoundingClientRect().top
      const height_n = header_e.offsetHeight
      const mode_n = atY_n > ( height_n * 0.5 ) ? -1 : 1
      lumMode__v( mode_n )
    } )

} ()

